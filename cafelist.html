<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Café List – Taste of Busan</title>
    <link rel="stylesheet" href="cafelist.css?v=1">
</head>

<body>
    <header>
        <button class="back-btn" style="background-color: rgb(3, 47, 14); font-weight: bold; width: 50px; height: 50px; font-size:xx-large;" onclick="history.back()">←</button>

        <h1>Taste of Busan – Café Discovery</h1>
        <h3>Explore the most Instagrammable and cozy cafés in Busan.</h3>
        <br><br>
        <hr style="width : 60%;">
        <br>
        <div class="filter-section" id="dynamicFilters"></div>
        
    </header>

    <main>
        <table id="cafe-table">
            <thead>
                <tr>
                    <th>Cafe</th>
                    <th>View</th>
                    <th>Menu</th>
                    <th>Interior</th>
                    <th>Region</th>
                    <th>Rating</th>
                </tr>
            </thead>
            <tbody id="cafe-list"></tbody>
        </table>
    </main>

    <script>
        const params = new URLSearchParams(location.search);
        const rawType = params.get('type');
        const initialValue = params.get('value');

        let allCafes = [];
        const activeFilters = {};

        const initialType = rawType
            ? rawType.charAt(0).toUpperCase() + rawType.slice(1)
            : null;

        if (initialType && initialValue) {
            activeFilters[initialType] = initialValue;
        }

        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const kst = new Date(utc + 9 * 3600000);
        const hhmm = kst.toTimeString().slice(0, 5);
        const dayIndex = kst.getDay();

        function getDayIndex(dayString) {
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            return days.indexOf(dayString.toLowerCase());
        }

        fetch('cafe.json?v=' + Date.now())
            .then(res => res.json())
            .then(data => {
                allCafes = data.cafes;
                generateDynamicFilters();
                applyFilters();
            })
            .catch(error => console.error('Error:', error));

        function generateDynamicFilters() {
            const container = document.getElementById('dynamicFilters');
            container.innerHTML = '';

            const filterKeys = ['View', 'Menu', 'Interior', 'Region', 'Rating'];

            filterKeys.forEach(filterKey => {
                if (activeFilters[filterKey]) return;

                let uniqueValues = [];
                if (filterKey === 'Rating') {
                    uniqueValues = [...new Set(allCafes.map(cafe =>
                        Math.floor(cafe.Rating * 2) / 2
                    ))].sort((a, b) => b - a);
                } else {
                    uniqueValues = [...new Set(allCafes.map(cafe => cafe[filterKey]))];
                }

                const filterGroup = document.createElement('div');
                filterGroup.className = 'filter-group';
                filterGroup.innerHTML = `
                    <label for="${filterKey}Filter">${filterKey}:</label>
                    <select 
                        class="filter-select" 
                        id="${filterKey}Filter"
                        onchange="updateFilter('${filterKey}', this.value)"
                    >
                        <option value="">전체</option>
                        ${uniqueValues.map(value => `
                            <option value="${value}">
                                ${filterKey === 'Rating' ? `${value}+` : value}
                            </option>
                        `).join('')}
                    </select>
                `;
                container.appendChild(filterGroup);
            });
        }

        window.updateFilter = function (key, value) {
            if (value) {
                activeFilters[key] = value;
            } else {
                delete activeFilters[key];
            }
            updateURL();
            applyFilters();
        }

        function updateURL() {
            const params = new URLSearchParams();
            Object.entries(activeFilters).forEach(([k, v]) => {
                if (v) params.set(k, v);
            });
            window.history.replaceState({}, '', `?${params.toString()}`);
        }

        function applyFilters() {
            let filtered = allCafes.filter(cafe =>
                Object.entries(activeFilters).every(([key, value]) => {
                    if (key === 'Rating') {
                        return cafe[key] >= parseFloat(value);
                    } else if (key === 'Open') {
                        const selectedDayIndex = getDayIndex(value);
                        const [open, close] = cafe.Open[selectedDayIndex];
                        return !(open === '00:00' && close === '00:00');
                    }
                    return cafe[key] === value;
                })
            );

            filtered.sort((a, b) => {
                const isOpenA = checkOpenStatus(a);
                const isOpenB = checkOpenStatus(b);
                if (isOpenA !== isOpenB) return isOpenB ? 1 : -1;
                return b.Rating - a.Rating;
            });

            renderCafeList(filtered);
        }



        function checkOpenStatus(cafe) {
            const [open, close] = cafe.Open[dayIndex];
            if (open === '00:00' && close === '00:00') return false;
            const currentMinutes = parseInt(hhmm.split(':')[0]) * 60 + parseInt(hhmm.split(':')[1]);
            const openMinutes = parseInt(open.split(':')[0]) * 60 + parseInt(open.split(':')[1]);
            const closeMinutes = parseInt(close.split(':')[0]) * 60 + parseInt(close.split(':')[1]);
            return currentMinutes >= openMinutes && currentMinutes <= closeMinutes;
        }

        function renderCafeList(cafes) {
            const listEl = document.getElementById('cafe-list');
            listEl.innerHTML = cafes.map(cafe => `
                <tr class="${checkOpenStatus(cafe) ? 'open' : 'closed'}">
                    <td><a href="cafedetail.html?name=${encodeURIComponent(cafe.Name)}">${cafe.Name}</a></td>
                    <td>${cafe.View}</td>
                    <td>${cafe.Menu}</td>
                    <td>${cafe.Interior}</td>
                    <td>${cafe.Region}</td>
                    <td>${cafe.Rating.toFixed(1)}</td>
                </tr>
            `).join('');
        }
    </script>
</body>

</html>